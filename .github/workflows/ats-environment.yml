name: ATS Environment Setup

on:
  push:
    branches: [main]
  workflow_dispatch:  # manual trigger

jobs:
  setup-environment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Connect and setup EC2 environment
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          echo "ğŸ”— Connecting to EC2..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} 'bash -s' <<'REMOTE'
            set -e
            echo "ğŸš€ Setting up ATS environment on EC2..."

            # Update & install dependencies
            sudo apt update -y
            sudo apt install -y python3 python3-venv python3-pip postgresql postgresql-contrib nginx nodejs npm git curl

            echo "âœ… Dependencies installed."

            # Ensure directories
            sudo mkdir -p /var/www/ats /var/www/ats-backups
            sudo chown -R ubuntu:www-data /var/www/ats /var/www/ats-backups
            echo "âœ… Directories ready."

            # ğŸŸ¢ PostgreSQL Setup
            echo "âš™ï¸ Configuring PostgreSQL..."
            sudo systemctl enable postgresql
            sudo systemctl start postgresql
            sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='ak_user';" | grep -q 1 || sudo -u postgres psql -c "CREATE USER ak_user WITH PASSWORD 'navat';"
            sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='ak_db';" | grep -q 1 || sudo -u postgres psql -c "CREATE DATABASE ak_db OWNER ak_user;"
            echo "âœ… PostgreSQL database and user verified."

            # ğŸŸ¡ Configure Nginx
            echo "âš™ï¸ Creating Nginx config..."
            NGINX_CONF=$(cat <<'NGINX'
server {
    listen 80;
    server_name _;
    root /var/www/ats/frontend/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /backend/ {
        rewrite ^/backend/?(.*)$ /$1 break;
        proxy_pass http://127.0.0.1:8000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
NGINX
)
            echo "$NGINX_CONF" | sudo tee /etc/nginx/sites-available/ats.conf > /dev/null
            sudo ln -sf /etc/nginx/sites-available/ats.conf /etc/nginx/sites-enabled/ats.conf
            sudo nginx -t || (echo "âŒ Nginx test failed!" && exit 1)
            echo "âœ… Nginx configuration verified (not started yet)."

            echo "ğŸ‰ ATS environment setup complete!"
REMOTE
