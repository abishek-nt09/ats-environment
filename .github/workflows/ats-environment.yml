name: ATS Environment Setup

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  setup-environment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy & Execute Environment Setup Script
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          echo "üì§ Copying setup script to EC2..."
          scp -o StrictHostKeyChecking=no -i private_key.pem scripts/setup_environment.sh ${USER}@${HOST}:/home/${USER}/

          echo "‚öôÔ∏è Running setup script on EC2..."
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} "
            sudo mkdir -p /opt/scripts
            sudo mv /home/${USER}/setup_environment.sh /opt/scripts/setup_environment.sh
            sudo chmod +x /opt/scripts/setup_environment.sh

            # Replace server_name dynamically in nginx config before setup
            sudo sed -i 's|REPLACE_WITH_IP|${HOST}|g' /opt/scripts/setup_environment.sh

            sudo bash /opt/scripts/setup_environment.sh
          "

          echo "‚úÖ Environment setup completed successfully!"
